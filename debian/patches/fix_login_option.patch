Description: * Fixed Bug #887105: login shell not working.
Origin: commit, revision id: david@pleyades.net-20111108102628-d690tmamnzsbvd58
Author: David GÃ³mez <david@pleyades.net>
Applied-Upstream: http://bazaar.launchpad.net/~dabisu/sakura/sakura/revision/371
Debian-Bug: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=639652
Bug: https://bugs.launchpad.net/sakura/+bug/887105

=== modified file 'src/sakura.c'
Index: sakura/src/sakura.c
===================================================================
--- sakura.orig/src/sakura.c	2012-01-23 13:51:26.819459683 -0500
+++ sakura/src/sakura.c	2012-01-23 14:09:22.594000296 -0500
@@ -196,7 +196,7 @@
 	gint scrollbar_key;
 	gint fullscreen_key;
 	GRegex *http_regexp;
-	char *argv[2];
+	char *argv[3];
 } sakura;
 
 struct terminal {
@@ -1824,13 +1824,15 @@
 		sakura.has_rgba = false;
 	}
 
-	/* Set argv for forked childs */
+	/* Set argv for forked childs. Real argv vector starts at argv[1] because we're
+	   using G_SPAWN_FILE_AND_ARGV_ZERO to be able to launch login shells */
+	sakura.argv[0]=g_strdup(g_getenv("SHELL"));
 	if (option_login) {
-		sakura.argv[0]=g_strdup_printf("-%s", g_getenv("SHELL"));
+		sakura.argv[1]=g_strdup_printf("-%s", g_getenv("SHELL"));
 	} else {
-		sakura.argv[0]=g_strdup(g_getenv("SHELL"));
+		sakura.argv[1]=g_strdup(g_getenv("SHELL"));
 	}
-	sakura.argv[1]=NULL;
+	sakura.argv[2]=NULL;
 
 	if (option_title) {
 		gtk_window_set_title(GTK_WINDOW(sakura.main_window), option_title);
@@ -2352,7 +2354,7 @@
 			}
 
 			vte_terminal_fork_command_full(VTE_TERMINAL(term->vte), VTE_PTY_DEFAULT, NULL, command_argv, NULL, 
-										   G_SPAWN_SEARCH_PATH, NULL, NULL, &term->pid, NULL);
+										   G_SPAWN_SEARCH_PATH|G_SPAWN_FILE_AND_ARGV_ZERO, NULL, NULL, &term->pid, NULL);
 			g_strfreev(command_argv);
 			option_execute=NULL;
 			g_strfreev(option_xterm_args);
@@ -2364,7 +2366,7 @@
 			}
 			/* TODO: Check the new command_full works ok with login shells */
 			vte_terminal_fork_command_full(VTE_TERMINAL(term->vte), VTE_PTY_DEFAULT, cwd, sakura.argv, NULL,
-										   G_SPAWN_SEARCH_PATH, NULL, NULL, &term->pid, NULL);
+										   G_SPAWN_SEARCH_PATH|G_SPAWN_FILE_AND_ARGV_ZERO, NULL, NULL, &term->pid, NULL);
 		}
 	/* Not the first tab */
 	} else {
@@ -2381,7 +2383,7 @@
 		 * says this is for "historical" reasons. Me arse */
 		gtk_notebook_set_current_page(GTK_NOTEBOOK(sakura.notebook), index);
 		vte_terminal_fork_command_full(VTE_TERMINAL(term->vte), VTE_PTY_DEFAULT, cwd, sakura.argv, NULL,
-									   G_SPAWN_SEARCH_PATH, NULL, NULL, &term->pid, NULL);
+									   G_SPAWN_SEARCH_PATH|G_SPAWN_FILE_AND_ARGV_ZERO, NULL, NULL, &term->pid, NULL);
 	}
 
 	free(cwd);
